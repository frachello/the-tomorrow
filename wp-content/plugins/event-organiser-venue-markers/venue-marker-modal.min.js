var eo_venue_marker=eo_venue_marker||{};
(function(d){var b;eo_venue_marker.media=b={buttonId:"#open-venue-marker-picker",selected:false,init:function(){d(b.buttonId).on("click",this.openMediaDialog);b.markers=new b.model.VenueMarkerList;for(var a=eo_venue.marker,c=0;c<eo_venue.markers.length;c++){var e=new b.model.VenueMarker(eo_venue.markers[c]),f=e.get("url");if(a==f){b.markers.setCurrent(e);e.set({selected:true})}b.markers.add(e)}},openMediaDialog:function(a){a.preventDefault();b.frame().open("eventorganiser-venue-marker")},closeMediaDialog:function(a){wp.media.editor.remove(a)},
frame:function(){if(this._frame)return this._frame;var a=[new b.controller.VenueMarkerList({title:"Map Markers",id:"venue-marker-list-state",priority:50}),new b.controller.UploadMarker({title:"Upload",id:"eo-upload-marker-state",priority:50})];this._frame=wp.media({className:"media-frame no-sidebar",states:a,state:"venue-marker-list-state"});this._frame.on("content:create:venue_marker_state",function(){var c=new eo_venue_marker.media.view.VenueMarkerList({controller:b.frame(),model:b.frame().state()});
b.frame().content.set(c)});this._frame.on("content:create:eo_upload_marker_state",function(){var c=new eo_venue_marker.media.view.UploadMarker({controller:b.frame(),model:b.frame().state()});b.frame().content.set(c)});this._frame.on("ready",this.ready);this._frame.on("toolbar:create:eo-venue-marker-tooblar",this.createToolbar,this);return this._frame},ready:function(){d(".media-modal").addClass("eo-venue-marker-modal")},createToolbar:function(a){var c={};c.controller=this;a.view=new b.view.SelectMarkerToolbar(c)}};
_.extend(b,{view:{},controller:{},model:{}});b.model.VenueMarker=Backbone.Model.extend({defaults:{url:false,name:false},toggleSelected:function(){this.collection.getCurrent()==this?this.collection.setCurrent(false):this.collection.setCurrent(this)}});b.model.VenueMarkerList=Backbone.Collection.extend({model:b.model.VenueMarker,initialise:function(){var a=this;_.bindAll(this,"setCurrent","getCurrent","_setupCurrent");a._current=null;a.on("change:current",this.rerenderViews)},rerenderViews:function(){},
setCurrent:function(a){this._setupCurrent(!(_.isString(a)||_.isNumber(a))?a:this.get(a))&&this.trigger("change:current",this._current);return this.getCurrent()},getCurrent:function(){return this._current},_setupCurrent:function(a){var c=this._current;this._current=a;if((b.selected=a)&&c&&c.id==a.id)return false;return true}});b.view.UploadMarker=wp.media.View.extend({template:wp.media.template("eo-upload-marker"),events:{submit:"startUpload"},render:function(){this.$el.html(this.template());d("#eo-venue-marker-submit").prop("disabled",
true);return this},startUpload:function(){this.$el.find('input[type="submit"]').prop("disabled",true);this.$el.find(".spinner").css({display:"inline-block"});return true},uploadComplete:function(a){this.$el.find('input[type="submit"]').prop("disabled",false);this.$el.find(".spinner").css({display:"none"});a&&this.$el.find("div.error").show().children().text(a);return true}});b.view.VenueMarkerList=wp.media.View.extend({className:"venue-marker-list",template:wp.media.template("venue-marker-list"),
initialize:function(){_.bindAll(this,"render","appendItem","prependItem");var a=this;a.collection=b.markers;a.collection.bind("add",this.prependItem);a.render();_(a.collection.models).each(function(c){a.appendItem(c)},a)},prependItem:function(a){a=new b.view.VenueMarker({model:a});this.$el.children("ul").prepend(a.render().el)},appendItem:function(a){a=new b.view.VenueMarker({model:a});this.$el.children("ul").append(a.render().el)}});b.view.VenueMarker=wp.media.View.extend({tagName:"li",className:"attachment save-ready",
template:wp.media.template("venue-marker"),events:{click:"toggleSelect"},initialize:function(){_.bindAll(this,"render","toggleSelect");this.model.bind("change",this.render)},render:function(){var a=this.model.toJSON();this.$el.html(this.template(a));a.selected?this.$el.addClass("details selected"):this.$el.removeClass("details selected");return this},toggleSelect:function(){var a=this.model.collection.getCurrent();this.model.toggleSelected();this.model.set({selected:true});a&&a.set({selected:false})}});
b.controller.VenueMarkerList=wp.media.controller.State.extend({defaults:{id:"venue-marker-list-state",menu:"default",content:"venue_marker_state",toolbar:"eo-venue-marker-tooblar"}});b.controller.UploadMarker=wp.media.controller.State.extend({defaults:{id:"eo-upload-marker-state",menu:"default",content:"eo_upload_marker_state",toolbar:"eo-no-toolbar"}});b.view.SelectMarkerToolbar=wp.media.View.extend({className:"eo-venue-marker-tooblar",template:wp.media.template("venue-marker-toolbar"),events:{"click input#eo-venue-marker-submit":"useMarker",
"click input#eo-venue-marker-cancel":"closeModal"},useMarker:function(){var a=b.selected?b.selected.get("url"):null;eo_venue.marker=a;marker.setIcon(a);d("#eo-venue-marker-url").val(a);a?d("#eo-venue-marker-thumbnail").attr("src",a):d("#eo-venue-marker-thumbnail").attr("src",eo_venue.default_marker);b.frame().close()},closeModal:function(){b.frame().close()}});d(document).ready(function(){b.init()})})(jQuery);
